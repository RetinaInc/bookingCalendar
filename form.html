<!DOCTYPE html>
<html>

<head>
    <title>JetForms!</title>

    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.2/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/2.2.7/fullcalendar.css">
    <link rel="stylesheet" type="text/css" href="libraries/bootstrap-timepicker.min.css">

	<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/2.2.7/fullcalendar.js"></script>
    <script src="libraries/spin.min.js"></script>

    <script src="libraries/bootstrap-timepicker.min.js"></script>

</head>

<body>
	<div id='calendar'></div>
    <div id="stepForm" class=".stepForm">
        <div id="loginFormWrapper">
        	<div class="formHeading">
        		<div class='cardTitle'>Book Room "Aphrodite"</div>
        		<span class="forDate"><span id="headingDateLbl">21/12/2016</span>, <span id="headingArrTimeTxt">11:00</span> - <span id="headingDepTimeTxt">13:00</span></span>
        	</div>
        	<div id="formSpinner"></div>
	       	<div id="formErrMsg">An error occured!</div>
        	<div class='state state1'>
        		<div id="roomContainer">
				</div>
        	</div>
        	<div class='state state2'>
        		<div id="nameInputWrapper" class="inputWrapper">
	                <input type="text" id="timepicker1" class="textInput input-small" placeholder="Full Name" name="username">
	            </div>
	            <div id="organizationInputWrapper" class="inputWrapper">
	                <input type="text" id="timepicker2" class="textInput input-small" placeholder="Click to set departure time" name="username">
	            </div>
        	</div>
        	<div class='state state3'>
	            <div id="nameInputWrapper" class="inputWrapper">
	                <input type="text" id="usernameInput" class="textInput" placeholder="Full Name" name="username">
	            </div>
	            <div id="organizationInputWrapper" class="inputWrapper">
	                <input type="text" id="passwordInput" class="textInput" placeholder="Organization" name="password">
	            </div>
	            <div id="phoneInputWrapper" class="inputWrapper">
	                <input type="text" id="usernameInput" class="textInput" placeholder="Phone Number" name="username">
	            </div>
	            <div id="emailInputWrapper" class="inputWrapper">
	                <input type="text" id="passwordInput" class="textInput" placeholder="Email" name="password">
	            </div>
	            <div class="panel-group optionsAccordion" id="accordion">
	                <div class="panel panel-default">
	                    <div class="panel-heading optionsAccordionHeading">
	                        <h4>
	              				<span data-toggle="collapse" data-parent="#accordion" href="#collapse1">Add options</span>
	            			</h4>
	                    </div>
	                    <div id="collapse1" class="panel-collapse collapse out">
	                        <div class="panel-body">Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</div>
	                    </div>
	                </div>
	                <hr>
	                <div class="priceBox">
	                	<span class="priceLbl">Price:</span><span class="priceTxt"><span style='font-weight:lighter;'>&euro;&nbsp;</span>39.90</span>
	                </div>
	            </div>
            </div>
                <div class="formBtnContainer">
	                <div id="cancelBtn" class="formBtn">
	                	Cancel
	            	</div>
	                <div id="nextBtn" class="formBtn">
	                	Next
	            	</div>
            	</div>

</body>

</html>


<script>

$(document).ready(function() {

	//Ajax JSON
	var bookingJSON={
		"firstSlot": "9:00",
		"lastSlot": "20:00",
		"number": 123,
		"string": "Hello World",
		"eventsArray": [
		{
		  "title": "Globalsoft Booking",
		  "start": "1423994400",
		  "end": "1424012400"
		},
		{
		  "title": "Opium Works Booking",
		  "start": "1422784800",
		  "end": "1422788400"
		},
		{
		  "title": "Private Booking",
		  "start": "1448953200",
		  "end": "1448971200"
		},
		{
		  "title": "Private Booking",
		  "start": "1423994400",
		  "end": "1424005200"
		}
		],
		"availableRooms": [
		{
		  "roomId": "room-55",
		  "roomName": "Aphrodite Room",
		  "roomDescription": "Lorem, ipsum solor dit amet,dit amet",
		  "roomImg": "http://gold-estate.lv/wp-content/uploads/2013/09/Modern-Interior-Design-7042.jpg",
		  "roomCapacity": 69,
		  "pricePerHour":39.00,
		  "minSlotHours" : 4
		},
		{
		  "roomId": "room-12",
		  "roomName": "Kostas Room",
		  "roomImg": "http://trinityriver.audubon.org/sites/default/files/photos/conference_room.jpg",
		  "roomDescription": "Lorem, ipsum solor dit amet,dit amet, ",
		  "roomCapacity": 124,
		  "pricePerHour":39.00,
		  "minSlotHours" : 4
		}
		],
		"calendarOptions": {
		"stepHour": 1,
		"c": "d",
		"e": "f"
		}
	}

	var stepHour = bookingJSON.calendarOptions.stepHour;
	var firstSlot = bookingJSON.firstSlot;
	var lastSlot = bookingJSON.lastSlot;
	var eventsArray = parseEventsUnix(bookingJSON.eventsArray);
	var availableRooms = bookingJSON.availableRooms;


	//DOM handles
	var stepForm = $("#stepForm");
	var allStates = $(".state");
	var nextBtn = $("#nextBtn");
	var formErrMsg = $("#formErrMsg");
	var headingDateLbl = $("#headingDateLbl");
	var headingArrTimeTxt = $("#headingArrTimeTxt");
	var headingDepTimeTxt = $("#headingDepTimeTxt");
	var formSpinner = document.getElementById('formSpinner');//spin.js does not accept jQuery, using vanilla instead
	var timepicker1 = $("#timepicker1");
	var timepicker2 = $("#timepicker2");
	var roomContainer = $("#roomContainer");



    var date = new Date();
    var d = date.getDate();
    var m = date.getMonth();
    var y = date.getFullYear();


	var spinnerOpts = {
		  lines: 20, 
		  length: 0, 
		  width: 5, 
		  radius: 15,
		  corners: 1, 
		  rotate: 0, 
		  direction: 1, 
		  color: '#fff', 
		  speed: 3, 
		  trail: 0, 
		  shadow: false, 
		  hwaccel: true, 
		  className: 'spinner', 
		  zIndex: 2e9, 
		  top: '50%', 
		  left: '50%' 
	};

    $('#calendar').fullCalendar({
        header: {
            left: 'prev,next today',
            center: 'title',
            right: 'month,agendaWeek,agendaDay'
        },
        ignoreTimezone:true,
        selectOverlap:false,
        allDaySlot:false,
        minTime: firstSlot,
        maxTime: lastSlot,
        slotDuration:'0'+stepHour+':00:00',
        selectable:true,
        defaultView: 'month',
        events: eventsArray,
        dayClick: function(date) {
                $('#calendar').fullCalendar('gotoDate', date);
                $('#calendar').fullCalendar('changeView', 'agendaDay');        
        },
        timeClick: function(){
        	alert("clicktime")
        },
        select: function(start,end,jsEvent,view){
        	console.log(view.name)
        	if(view.name==="agendaDay"){
        		$("#calendar").css('opacity','0.3');
        		var startDate = moment(start,'X');
        		var endDate = moment(end,'X');
            	form.show(null,startDate,endDate);
        	}
        }
    });

    $(timepicker1).timepicker({
        template: 'dropdown',
        showSeconds: false,
        showMeridian: false,
        defaultTime: false
    });

    $(timepicker1).css('pointer-events','none');//lock this since it's not user changeable

    $(timepicker2).timepicker({
    	minuteStep:stepHour*60,
        template: 'dropdown',
        showSeconds: false,
        showMeridian: false,
        defaultTime: false
    });


    $("#cancelBtn").click(function(){
    	$("#calendar").css('opacity','1');
    	$('.stepForm').fadeOut();
    	form.resetForm();
    });

    $("#nextBtn").click(function(){
    	form.nextState();
    });


    var form ={

    	//vars
    	mode : "booking", //current mode, other could be e.g 'join event'
    	state: "1", //default state(view) of form
    	arrDate:"00:00", //arrival time - selectable on calendar - also displayed on form
    	depDate:"01:00", //departure time - selectable on form 
    	steppedUpTime:"01:00", //arr time + step -initial time of departure timepicker
    	selectedRoomId:"0", //currently selected room
    	errHideDelay:3000, //time to show err msg before hiding


    	//methods

    	init: function(){

    		this.appendRooms();
			window.spinner = new Spinner(spinnerOpts).spin(formSpinner);
			this.waitForm(false);
    	},

   		resetState: function(){
   			$(stepForm).fadeOut(200, function(){
   				$(allStates).css('display','none');
   				$('.state'+this.state).css('display','block');
   			});
   		},

    	resetForm: function(){

    		this.state = "1";
    		$('#stepForm input') .not(':button, :submit, :reset')
			  .val('')
			  .removeAttr('checked')
			  .removeAttr('selected');

			this.resetState();
    	},

    	showState:function(stateNum){
    		$(allStates).css('display','none');
    		$(".state"+stateNum).css('display','block');
    	},

    	show : function(stateNum,startDate,endDate){

    		if(stateNum === null)
    			var stateNum = "1";

    		$(allStates).css('display','none');
    		$(".state"+stateNum).css('display','block');
    		$(stepForm).fadeIn();


        	startTimeFormatted = startDate.format('H:mm');
  			$(timepicker1).timepicker('setTime', startTimeFormatted);

  			this.steppedUpTime =  endDate.format('H:mm');
  			$(timepicker2).timepicker('setTime',this.steppedUpTime);

  			this.arrDate = startDate.format('YYYY-MM-DD');
  			this.depDate = endDate.format('YYYY-MM-DD');

  			$(headingDateLbl).text(endDate.format('MMMM Do YYYY'));
  			$(headingArrTimeTxt).text(startDate.format('H:mm'));
  			$(headingDepTimeTxt).text(endDate.format('H:mm'));

  		},

    	nextState: function(){
			this.state++;
    		$(allStates).fadeOut(200, function(){
    			$(".state"+form.state).fadeIn(100);
    		});

			switch(this.state) {
			    case 3:

			        var finalArrTime = $(timepicker1).val();
			        var finalDepTime = $(timepicker2).val();

			        this.arrDate = moment(this.arrDate+'T'+finalArrTime).utc().format('X'); //final save of arrTime in unix time
			        this.depDate = moment(this.depDate+'T'+finalDepTime).utc().format('X'); //final save of depTime in unix time

			        break;
			    case 4:
			       console.log(JSON.stringify(form));
			        break;
			    default:
			        console.log('nextState form. method defaulted switch case')
			}
    	},

    	setSelection: function(unix){

    	},

    	//appends available rooms to form/room container
		appendRooms: function(){
			var preselClassName = "preselectedRoom";
			var activeClass = "";//used internally don't change
			if(availableRooms.length<1){
				$(roomContainer).append("<p class='noDataPar'>No rooms available for this date</p>");
				return;
			}
			for (var i = 0; i < availableRooms.length; i++) {
				var roomId = availableRooms[i].roomId;
				var roomName = availableRooms[i].roomName;
				var roomDesc = availableRooms[i].roomDescription;
				var roomImg = availableRooms[i].roomImg;
				var roomCapacity = String(availableRooms[i].roomCapacity);
					if(i===0){
						activeClass= preselClassName;
					}
					else{
						activeClass="";
					}

				$(roomContainer).append("<div class='roomRow "+activeClass+"' data-roomId='"+roomId+"'' ><div class='roomSnippet' ><img class='roomThumb' src='"+roomImg+"'/><div class='roomSnippetTxtContainer'><div class='roomSnippetTxtTitle'>"+roomName+"<span class='roomCapacityLbl'>Capacity: </span><span class='roomCapacityTxt'>"+roomCapacity+"</span></div><div class='roomSnippetTxtDescription'>"+roomDesc+"</div></div></div></div>");
			}
			this.selectedRoomId = availableRooms[0].roomId;

			var allRoomRows = $('.roomRow');
			$('body').on('click', '.roomRow', function() {
			   $(allRoomRows).removeClass(preselClassName);
			   $(this).addClass(preselClassName);
			   this.selectedRoomId = $(this).attr('data-roomId');
			});
		},

		showError: function(msg){

			$(formErrMsg).text(msg);
			$(formErrMsg).css('display','block');
			setTimeout(function(){
				$(formErrMsg).css('display','none');
			},this.errHideDelay);

		},

		//shows/hides AJAX spinners, also interlocks the form to prevent user actions during wait
		waitForm: function(bool){
			if(bool){
				$(stepForm).css('pointer-events','none');
				disableNext(true);
				$(formSpinner).fadeIn();
				setTimeout(function(){
					$(stepForm).css('pointer-events','all');
					disableNext(false);
					$(formSpinner).fadeOut();
				},2000);
			}else{
				$(stepForm).css('pointer-events','all');
				disableNext(false);
				$(formSpinner).fadeOut();
			}
		}




    }


    form.init();


	//watch times on timepickers - stop user from maxing it or going below arrival time
	var origColorTimepickerColor = $(timepicker2).css('color');
	$(timepicker2).bind('change', function() { 

		var arrTimeAbs = absoluteTime($(timepicker1).val());
	    var depTimeAbs = absoluteTime($(this).val());
	    var openTimeAbs = absoluteTime(firstSlot);
	    var closeTimeAbs = absoluteTime(lastSlot);

	    if(depTimeAbs<=openTimeAbs||depTimeAbs>=(closeTimeAbs+stepHour)||depTimeAbs<=arrTimeAbs){
	    	$(timepicker2).css('color','red');
	    	form.showError('Depart time is sooner than arrival');
	    	disableNext(true);
	    }else{
	    	$(timepicker2).css('color',origColorTimepickerColor);
	    	disableNext(false);
	    }

	    if(depTimeAbs>=(closeTimeAbs+stepHour)){
	    	form.showError("Depart time is later than last available slot");
	    }


	});

	//parses an event array - transforms unix timestamps to datestrings for start/end times
	function parseEventsUnix(eventsArr){
		for (var i = 0; i < eventsArr.length; i++) {
			if (typeof eventsArr[i].start!=='undefined')
				eventsArr[i].start = moment.unix(eventsArr[i].start).utc().format();
				eventsArr[i].end = moment.unix(eventsArr[i].end).utc().format();
		};
		return eventsArr;
	}

	function disableNext(bool){
		if (bool){
			$(nextBtn).addClass('formBtnDisabled');
		}else{
			$(nextBtn).removeClass('formBtnDisabled');
		}
	}


	//converts times to absolute hours, e.g 08:30->8
	function absoluteTime(time){
		var thisTime = time.split(":");
		if(thisTime[0]==="0")
			thisTime.slice(1); //if 0830 make it 830.
		returnTime = thisTime[0];
		return parseInt(returnTime);
	}
   

});

</script>

<style>

@import url(http://fonts.googleapis.com/css?family=Noto+Sans:400,700,400italic,700italic);

*{
	font-family:'Noto Sans',sans-serif;
}


#formSpinner{
	visibility:visible;
	position:absolute;
	width:48px;
	height:48px;
	margin:auto;
	top:0;
	right:6px;
	background-color:transparent;
	z-index:999;
	pointer-events:none;
}

#formErrMsg{
	display:none;
	font-size:12px;
	color:#F44336;
	text-align: center;
}


.noDataPar{
	padding: 32px;
	color: #aaa;
}

.roomRow{
	width:100%;
	height:64px;
	margin-bottom:12px;
	cursor:pointer;
}

.roomRow:hover{
	background-color:#FCFAFA;
}

.preselectedRoom{
	background-color:#F0F0F0;
	color:#eee !important;
}


.roomSnippet{
	position:relative;
	width:240px;
	height:64px;
	padding-left:54px;
	margin:0 auto;
}

.roomThumb{
	display:block;
	position:absolute;
	width: 48px;
	height: 48px;
	margin:auto;
	top:0;
	bottom:0;
	left:0;
	border-radius: 50%;
	border: 1px solid #aaa;
}

.roomSnippetTxtContainer{
	padding-top:14px;
	border-bottom: 1px solid #eee;
	padding-bottom: 6px;
}

.roomSnippetTxtTitle{
	width:60%;
	white-space: nowrap;
	overflow: hidden;
	text-overflow: ellipsis;
	font-size:14px;
	color:#000;
}

.roomSnippetTxtDescription{
	width: 100%;
	white-space: nowrap;
	overflow: hidden;
	text-overflow: ellipsis;
	font-size: 12px;
	color: #aaa;
}


.roomCapacityLbl{
	position: absolute;
	margin: auto;
	right: 24px;
	top: 16px;
	color: #aaa;
	font-size: 10px;
}

.roomCapacityTxt{
	position: absolute;
	margin: auto;
	right: 8px;
	top: 16px;
	color: #aaa;
	font-size: 10px;
}


#calendar{
	position:absolute;
	width:70%;
	margin:auto;
	top:0;
	bottom:0;
	left:0;
	right:0;
	z-index:-1;
}


#calendar .fc-toolbar{
	background-color: #00BCD4;
	margin-bottom:0;
	color:#fff;
	height:64px;
}

#calendar .fc-toolbar h2{
	margin-top:22px;
	font-size:20px;
}

#calendar .fc-toolbar .fc-button{
	height: 64px;
	border: 0;
	background-image: none;
	background-color: transparent;
	color:#fff;
}

#calendar .fc-toolbar .fc-button span{
	color:#fff;
}

.fc-day-header{
	background-color: #90CAF9;
	color:#fff;
	font-size:12px;
}


/*Form Styles*/
	#stepForm{
		display:none;
	}

	.state2{
		display:none;
	}

	.stepForm{
		display:none;
	}

	.formHeading{
		width:100%;
		height:56px;
		line-height:36px;
		font-size:18px;
		font-weight:lighter;
		padding-left:32px;
		color:#fff;
		background-color:#00BCD4;
		margin-bottom:8px;
	}

	.cardTitle{
		height:18px;
	}

	.forDate{
		font-size:12px;
		color:#eee;
	}

	.formBtnContainer{
		position:absolute;
		width:100%;
		height:54px;
		margin: auto;
		bottom:0;
		border-top:1px solid #ccc;
	}

	.formBtn{
		font-size: 14px;
		font-weight: bold;
		color: #00BCD4;
		text-transform: uppercase;
		cursor: pointer;
		height: 54px;
		line-height: 54px;
		padding: 0px 32px;
	}

	.formBtn:hover{
		background-color:#00BCD4;
		color:#fff;
	}

	.formBtnDisabled{
		pointer-events:none;
		color:#aaa;
	}


	#cancelBtn{
		width:50%;
		float:left;
	}

	#nextBtn{
		float:right;
		width:50%;
		text-align:right;
	}
	

	h3{
		font-size:18px;
		color:#fff;
	}

	.optionsAccordion h4{
		padding:0;
		margin:0;
		font-size: 14px;
		color: #00BCD4;
	}

	.priceBox{
		color: #333;
		background-color: #fff;
		border-radius: 2px;
		margin-top:12px;
		border-bottom:1px solid #00BCD4;
	}

	.priceBox .priceLbl{
		display: inline-block;
		height: 100%;
		width: 25%;
		color: #999;
		padding: 6px;
		border-radius: 2px 0px 0px 2px;
	}

	.priceBox .priceTxt{
		display:inline-block;
		float:right;
		font-size:18px;
		font-weight: bold;
		color:#555;
		padding: 6px;
	}

	::-webkit-input-placeholder { /* WebKit browsers */
    color:    #00BCD4;
	}
	:-moz-placeholder { /* Mozilla Firefox 4 to 18 */
	   color:    #00BCD4;
	   opacity:  1;
	}
	::-moz-placeholder { /* Mozilla Firefox 19+ */
	   color:    #00BCD4;
	   opacity:  1;
	}
	:-ms-input-placeholder { /* Internet Explorer 10+ */
	   color:    #00BCD4;
	}

    /*remove webkit autocomplete and border highlighting*/
    
    input:-webkit-autofill {
        -webkit-box-shadow: 0 0 0 1000px #fff inset;
    }
    textarea:focus,
    input:focus {
        outline: 0;
    }
    body {
        background-color: #fff;
        font-family: 'Noto Sans', sans-serif;
    }
    .formContainer {
        position: relative;
        margin: 0 auto;
    }

    #loginFormWrapper {
        position: relative;
        width: 300px;
        height: auto;
        margin: 10% auto;
        background-color: #fff;
        border-radius: 2px;
        padding-bottom:64px;
        box-shadow: 0px 1px 5px 2px #ccc
    }

    .optionsAccordion{
    	width:240px;
    	margin:0 auto;
    	margin-top:24px;
    	margin-bottom:8px;
    }

    .panel-default,
    .optionsAccordionHeading{
    	background-color:transparent !important;
    	border:0 !important;
    	border:0px solid #fff;
		cursor:pointer !important;
    }

    .optionsAccordionHeading{
    	background-size:20px;
    	background-repeat: no-repeat;
		background-position: -1px 6px;
    	background-image:url('img/plus.png');
    	padding-left:30px;
    }

    .inputWrapper {
        display: block;
        position: relative;
        width: 240px;
        height: 42px;
        margin: 0 auto;
        padding-left: 28px;
        border-radius: 2px;
        border: none;
        background-size: 18px;
        background-position: left;
        background-repeat: no-repeat;
        background-color: transparent;
        margin-bottom: 12px;
    }


    #nameInputWrapper {
        background-image: url('img/user.png');
    }

    #organizationInputWrapper {
        background-image: url('img/organization.png');
    }

    #phoneInputWrapper {
        background-image: url('img/phone.png');
    }

    #emailInputWrapper {
        background-image: url('img/email.png');
    }


    .textInput {
        position: relative;
        float: right;
        width: 100%;
        height: 100%;
        border: 0px;
        border-radius: 2px;
        color: #333;
    	background-color: transparent;
		border-bottom: 1px solid #ccc;
    }

    #emailSpinner,
    #loginSpinner {
        visibility: hidden;
        position: absolute;
        left: 6px;
        top: 10px;
        width: 22px;
        height: 22px;
    }
    .errorMsg {
        display: none;
        position: absolute;
        width: 100%;
        top: 240px;
        left: 0;
        right: 0;
        text-align: center;
        font-size: 14px;
        color: #A50A01;
        font-weight: bold;
    }
    .bottomLink {
        position: absolute;
        bottom: 8px;
        left: 0;
        right: 0;
        margin: auto;
        display: block;
        width: 100%;
        overflow: auto;
        font-size: 14px;
        text-align: center;
        color: #eee;
        cursor: pointer;
    }
    .bottomLink:hover {
        color: #fff;
        text-decoration: underline;
    }
</style>